<div class="dashboard-container">
  <!-- Header -->
  <div class="dashboard-header">
    <h1><i class="fas fa-chart-line"></i> Dashboard de Cartera</h1>
    <div class="dashboard-controls">
      <select class="form-control" [(ngModel)]="periodoDashboard" (change)="actualizarDashboard()">
        <option value="hoy">Hoy</option>
        <option value="semana">Esta semana</option>
        <option value="mes" selected>Este mes</option>
        <option value="trimestre">Este trimestre</option>
      </select>
      <button class="btn btn-primary" (click)="actualizarDashboard()" [disabled]="cargandoDashboard">
        <i class="fas fa-sync-alt" [class.fa-spin]="cargandoDashboard"></i>
        Actualizar
      </button>
    </div>
  </div>

  <!-- ============================================ -->
  <!-- SECCIÓN 1: CARTERA GENERAL -->
  <!-- ============================================ -->
  <div class="section">
    <h2 class="section-title">Cartera Total</h2>
    <div class="cards-grid">
      <div class="card">
        <div class="card-header">
          <i class="fas fa-wallet text-primary"></i>
          <h3>Cartera Total</h3>
        </div>
        <div class="card-body">
          <div class="card-value">{{ formatearMoneda(carteraTotal) }}</div>
          <div class="card-details">
            <span>{{ totalCreditos }} créditos</span>
            <span>{{ clientesVigentes }} clientes</span>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="card-header">
          <i class="fas fa-check-circle text-success"></i>
          <h3>Cartera Corriente</h3>
        </div>
        <div class="card-body">
          <div class="card-value">{{ formatearMoneda(carteraCorriente) }}</div>
          <div class="card-percentage">{{ getPorcentajeCarteraCorriente() }}%</div>
          <div class="card-details">{{ creditosVigentes }} créditos vigentes</div>
        </div>
      </div>

      <div class="card">
        <div class="card-header">
          <i class="fas fa-exclamation-triangle text-warning"></i>
          <h3>Cartera Vencida</h3>
        </div>
        <div class="card-body">
          <div class="card-value">{{ formatearMoneda(carteraVencida) }}</div>
          <div class="card-percentage">{{ porcentajeCarteraVencida }}%</div>
          <div class="card-details">{{ creditosVencidos }} créditos vencidos</div>
        </div>
      </div>

      <div class="card">
        <div class="card-header">
          <i class="fas fa-clock text-danger"></i>
          <h3>Cartera en Mora</h3>
        </div>
        <div class="card-body">
          <div class="card-value">{{ formatearMoneda(carteraMora) }}</div>
          <div class="card-percentage">{{ porcentajeCarteraMora }}%</div>
          <div class="card-details">{{ clientesMora }} clientes en mora</div>
        </div>
      </div>
    </div>
  </div>

  <!-- ============================================ -->
  <!-- SECCIÓN 2: GRÁFICOS -->
  <!-- ============================================ -->
  <div class="section">
    <h2 class="section-title">Distribución de Cartera</h2>
    <div class="charts-grid">
      <div class="chart-container">
        <canvas #distribucionChart></canvas>
      </div>
      <div class="chart-container">
        <canvas #ingresosChart></canvas>
      </div>
    </div>
  </div>

  <!-- ============================================ -->
  <!-- SECCIÓN 3: INGRESOS Y MINISTRACIONES -->
  <!-- ============================================ -->
  <div class="section">
    <h2 class="section-title">Ingresos y Ministraciones</h2>

    <!-- Ingresos Totales -->
    <div class="subsection">
      <h3>Ingresos Totales Acumulados</h3>
      <div class="cards-grid">
        <div class="card">
          <div class="card-header">
            <i class="fas fa-money-bill-wave text-primary"></i>
            <h4>Total General</h4>
          </div>
          <div class="card-body">
            <div class="card-value">{{ formatearMoneda(ingresosTotalGeneral) }}</div>
          </div>
        </div>

        <div class="card">
          <div class="card-header">
            <i class="fas fa-coins text-success"></i>
            <h4>Capital</h4>
          </div>
          <div class="card-body">
            <div class="card-value">{{ formatearMoneda(ingresosCapitalTotal) }}</div>
          </div>
        </div>

        <div class="card">
          <div class="card-header">
            <i class="fas fa-percentage text-info"></i>
            <h4>Intereses</h4>
          </div>
          <div class="card-body">
            <div class="card-value">{{ formatearMoneda(ingresosInteresesTotal) }}</div>
          </div>
        </div>

        <div class="card">
          <div class="card-header">
            <i class="fas fa-exclamation-circle text-danger"></i>
            <h4>Moratorios</h4>
          </div>
          <div class="card-body">
            <div class="card-value">{{ formatearMoneda(ingresosMoratoriosTotal) }}</div>
          </div>
        </div>
      </div>
    </div>

    <!-- Ministraciones -->
    <div class="subsection">
      <h3>Ministraciones</h3>
      <div class="cards-grid">
        <div class="card">
          <div class="card-header">
            <i class="fas fa-hand-holding-usd text-success"></i>
            <h4>Entregadas</h4>
          </div>
          <div class="card-body">
            <div class="card-value">{{ formatearMoneda(ministracionesEntregados) }}</div>
          </div>
        </div>

        <div class="card">
          <div class="card-header">
            <i class="fas fa-undo text-warning"></i>
            <h4>Devolución</h4>
          </div>
          <div class="card-body">
            <div class="card-value">{{ formatearMoneda(ministracionesDevolucion) }}</div>
          </div>
        </div>

        <div class="card">
          <div class="card-header">
            <i class="fas fa-calculator text-primary"></i>
            <h4>Total Neto</h4>
          </div>
          <div class="card-body">
            <div class="card-value">{{ formatearMoneda(ministracionesTotal) }}</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- ============================================ -->
  <!-- SECCIÓN 4: ANÁLISIS POR ALIADO -->
  <!-- ============================================ -->
  <div class="section">
    <h2 class="section-title">Análisis por Aliado</h2>

    <div class="tables-grid">
      <!-- Top Aliados por Cartera -->
      <div class="table-container">
        <h3><i class="fas fa-trophy"></i> Top Aliados por Cartera</h3>
        <table class="table">
          <thead>
            <tr>
              <th>Aliado</th>
              <th>Créditos</th>
              <th>Cartera</th>
              <th>Entregados</th>
              <th>% Total</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let aliado of topAliados">
              <td>{{ aliado.nombre }}</td>
              <td>{{ aliado.creditos }}</td>
              <td>{{ formatearMoneda(aliado.cartera) }}</td>
              <td>{{ formatearMoneda(aliado.entregados) }}</td>
              <td>{{ getPorcentajeCarteraAliado(aliado.cartera) }}%</td>
            </tr>
          </tbody>
        </table>
      </div>

      <!-- Mora por Aliado -->
      <div class="table-container">
        <h3><i class="fas fa-exclamation-triangle text-danger"></i> Mora por Aliado</h3>
        <table class="table">
          <thead>
            <tr>
              <th>Aliado</th>
              <th>Monto en Mora</th>
              <th>% Mora Total</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let aliado of moraPorAliado">
              <td>{{ aliado.nombre }}</td>
              <td>{{ formatearMoneda(aliado.mora) }}</td>
              <td>{{ getPorcentajeMora(aliado.mora) }}%</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- Gráfico de Mora por Aliado -->
    <div class="chart-full">
      <canvas #moraAliadoChart></canvas>
    </div>
  </div>

  <!-- ============================================ -->
  <!-- SECCIÓN 5: LISTADOS IMPORTANTES -->
  <!-- ============================================ -->
  <div class="section">
    <h2 class="section-title">Listados y Alertas</h2>

    <div class="tables-grid">
      <!-- Próximos Vencimientos -->
      <div class="table-container">
        <h3><i class="fas fa-calendar-alt"></i> Próximos Vencimientos</h3>
        <table class="table">
          <thead>
            <tr>
              <th>Cliente</th>
              <th>Crédito</th>
              <th>Monto</th>
              <th>Fecha</th>
              <th>Días</th>
              <th>Aliado</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let vencimiento of proximosVencimientos">
              <td>{{ vencimiento.cliente }}</td>
              <td>{{ vencimiento.credito_id }}</td>
              <td>{{ formatearMoneda(vencimiento.monto) }}</td>
              <td>{{ formatearFecha(vencimiento.fecha) }}</td>
              <td>
                <span [class]="vencimiento.dias <= 3 ? 'badge badge-danger' : 'badge badge-warning'">
                  {{ vencimiento.dias }} días
                </span>
              </td>
              <td>{{ vencimiento.aliado }}</td>
            </tr>
          </tbody>
        </table>
      </div>

      <!-- Alertas de Mora -->
      <div class="table-container">
        <h3><i class="fas fa-exclamation-circle text-danger"></i> Alertas de Mora</h3>
        <table class="table">
          <thead>
            <tr>
              <th>Cliente</th>
              <th>Días Mora</th>
              <th>Monto Vencido</th>
              <th>Saldo Pendiente</th>
              <th>Aliado</th>
              <th>Acción</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let alerta of alertasMora">
              <td>{{ alerta.cliente }}</td>
              <td>
                <span [class]="alerta.dias_mora > 30 ? 'badge badge-danger' : 'badge badge-warning'">
                  {{ alerta.dias_mora }} días
                </span>
              </td>
              <td>{{ formatearMoneda(alerta.monto_vencido) }}</td>
              <td>{{ formatearMoneda(alerta.saldo_pendiente) }}</td>
              <td>{{ alerta.aliado }}</td>
              <td>
                <button class="btn btn-sm btn-outline-primary" (click)="contactarCliente(alerta)">
                  <i class="fas fa-phone"></i>
                </button>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- Al Día -->
    <div class="subsection">
      <h3><i class="fas fa-calendar-day text-success"></i> Al Día - {{ formatearFecha(fechaActual) }}</h3>
      <div class="cards-grid">
        <div class="card">
          <div class="card-header">
            <i class="fas fa-hand-holding-usd text-success"></i>
            <h4>Créditos Entregados</h4>
          </div>
          <!-- <div class="card-body">
            <div class="card-value">{{ creditosDia.filter(c => c.estado === 'ENTREGADO').length }}</div>
            <div class="card-details">
              <span *ngFor="let credito of creditosDia.filter(c => c.estado === 'ENTREGADO')">
                {{ credito.cliente }}: {{ formatearMoneda(credito.monto) }}
              </span>
            </div>
          </div> -->
          <div class="card-body">
            <div class="card-value">
              {{ creditosEntregados ? creditosEntregados.length : 0 }}
            </div>

            <div class="card-details">
              <span *ngIf="creditosEntregados && creditosEntregados.length > 0; else sinCreditos">
                <span *ngFor="let credito of creditosEntregados; let i = index">
                  {{ credito.cliente || getNombreCliente(credito) }}: {{ formatearMoneda(credito.monto_aprobado ||
                  credito.monto || 0) }}
                  <br *ngIf="i < creditosEntregados.length - 1">
                </span>
              </span>
              <ng-template #sinCreditos>
                <span>No hay créditos entregados hoy</span>
              </ng-template>
            </div>
          </div>
        </div>

        <div class="card">
          <div class="card-header">
            <i class="fas fa-file-contract text-info"></i>
            <h4>Créditos Registrados</h4>
          </div>
          <div class="card-body">
            <div class="card-value">{{ creditosDia.length }}</div>
            <div class="card-details">
              Total registrados hoy
            </div>
          </div>
        </div>

        <div class="card">
          <div class="card-header">
            <i class="fas fa-users text-primary"></i>
            <h4>Clientes Nuevos</h4>
          </div>
          <div class="card-body">
            <div class="card-value">5</div>
            <div class="card-details">
              Clientes registrados hoy
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- ============================================ -->
  <!-- RESUMEN ESTADÍSTICO -->
  <!-- ============================================ -->
  <div class="section">
    <h2 class="section-title">Resumen Estadístico</h2>
    <div class="stats-grid">
      <div class="stat-item">
        <div class="stat-label">Tasa de Morosidad</div>
        <div class="stat-value">{{ tasaMorosidad }}%</div>
      </div>
      <div class="stat-item">
        <div class="stat-label">Ingresos del Período</div>
        <div class="stat-value">{{ formatearMoneda(ingresosPeriodo) }}</div>
      </div>
      <div class="stat-item">
        <div class="stat-label">Ministraciones Netas</div>
        <div class="stat-value">{{ formatearMoneda(ministracionesTotal) }}</div>
      </div>
    </div>
  </div>

  <!-- Footer -->
  <div class="dashboard-footer">
    <div class="footer-info">
      <span><i class="fas fa-clock"></i> Última actualización: {{ formatearFecha(fechaActual) }}</span>
      <span><i class="fas fa-database"></i> {{ creditos.length }} créditos cargados</span>
      <span><i class="fas fa-receipt"></i> {{ pagos.length }} pagos registrados</span>
    </div>
  </div>
</div>