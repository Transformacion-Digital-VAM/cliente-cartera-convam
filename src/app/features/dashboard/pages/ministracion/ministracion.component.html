<div class="admin-container">
  <!-- Migajas de Pan -->
  <nav class="breadcrumb-nav" aria-label="Migajas de pan">
    <ol class="breadcrumb">
      <li class="breadcrumb-item">
        <a href="/dashboard" class="breadcrumb-link">INICIO</a>
      </li>
      <li class="breadcrumb-item active" aria-current="page">
        ENTREGAR CRÉDITOS
      </li>
    </ol>
  </nav>

  <!-- Encabezado -->
  <header class="admin-header">
    <h1 class="reset-title">MINISTRACIÓN DE CRÉDITOS</h1>
  </header>

  <!-- Contenido principal -->
  <div class="admin-content">
    <!-- Barra de búsqueda y filtros -->
    <div class="filtros-section">
      <div class="filtros-card">
        <h3>FILTRAR CLIENTES</h3>
        <div class="filtros-form">
          <div class="form-group">
            <label class="form-label">NOMBRE</label>
            <input type="text" class="form-control" placeholder="Buscar por nombre..." [(ngModel)]="filtroNombre">
          </div>
          <div class="form-group">
            <label class="form-label">APELLIDO PATERNO</label>
            <input type="text" class="form-control" placeholder="Buscar por apellido paterno..."
              [(ngModel)]="filtroApPaterno">
          </div>
          <div class="botones-filtros">
            <button class="btn btn-primary" (click)="buscar()">
              <i class="fas fa-search"></i> BUSCAR
            </button>
            <button class="btn btn-outline" (click)="limpiarFiltros()">
              <i class="fas fa-undo"></i> LIMPIAR
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Pestañas de navegación -->
    <nav>
      <ul class="nav nav-tabs" id="creditosTab" role="tablist">
        <li class="nav-item" role="presentation">
          <button class="nav-link active" id="solicitudes-tab" data-bs-toggle="tab" data-bs-target="#solicitudes"
            type="button" role="tab" aria-controls="solicitudes" aria-selected="true">
            <i class="fas fa-file-alt me-2"></i>SOLICITUDES APROBADAS
            <span class="badge bg-primary ms-2">{{solicitudesAprobadas.length}}</span>
          </button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" id="pendientes-tab" data-bs-toggle="tab" data-bs-target="#pendientes" type="button"
            role="tab" aria-controls="pendientes" aria-selected="false">
            <i class="fas fa-clock me-2"></i>CRÉDITOS PENDIENTES
            <span class="badge bg-primary ms-2">{{getCreditosPorEstado('PENDIENTE').length}}</span>
          </button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" id="entregados-tab" data-bs-toggle="tab" data-bs-target="#entregados" type="button"
            role="tab" aria-controls="entregados" aria-selected="false">
            <i class="fas fa-check-circle me-2"></i>CRÉDITOS ENTREGADOS
            <span class="badge bg-primary ms-2">{{getCreditosPorEstado('ENTREGADO').length}}</span>
          </button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" id="devolucion-tab" data-bs-toggle="tab" data-bs-target="#devolucion" type="button"
            role="tab" aria-controls="devolucion" aria-selected="false">
            <i class="fas fa-redo me-2"></i>CRÉDITOS DEVOLUCIÓN
            <span class="badge bg-primary ms-2">{{getCreditosPorEstado('DEVOLUCION').length}}</span>
          </button>
        </li>
      </ul>
    </nav>

    <!-- Contenido de las pestañas -->
    <div class="tab-content pt-4" id="creditosTabContent">
      <!-- Pestaña 1: Solicitudes Aprobadas -->
      <div class="tab-pane fade show active" id="solicitudes" role="tabpanel" aria-labelledby="solicitudes-tab">
        <div class="tabla-section-vertical">
          <div class="tabla-header">
            <h3>SOLICITUDES APROBADAS PARA MINISTRACIÓN (ÚLTIMAS 6)</h3>
            <div class="botones-filtros">
              <button class="btn btn-outline btn-sm" (click)="cargarDatosIniciales()" [disabled]="cargando">
                <i class="fas fa-sync-alt" [class.fa-spin]="cargando"></i>
                {{ cargando ? 'Cargando...' : 'ACTUALIZAR' }}
              </button>
            </div>
          </div>

          <div class="table-container-vertical">
            <table class="table">
              <thead>
                <tr>
                  <th class="text-center">ID SOLICITUD</th>
                  <th class="text-center">ID CLIENTE</th>
                  <th>NOMBRE DEL CLIENTE</th>
                  <th>MONTO APROBADO</th>
                  <th>TASA DE INTERES</th>
                  <th>ALIADA</th>
                  <th class="text-center">FECHA DE APROBACIÓN</th>
                  <th class="actions-cell">ACCIONES</th>
                </tr>
              </thead>
              <tbody>
                <!-- Estado de carga -->
                <tr *ngIf="cargando">
                  <td colspan="8" class="text-center">
                    <i class="fas fa-spinner fa-spin"></i> Cargando Datos...
                  </td>
                </tr>

                <!-- Sin solicitudes -->
                <tr *ngIf="!cargando && !haySolicitudes">
                  <td colspan="8" class="text-center">
                    No hay solicitudes aprobadas para ministración
                  </td>
                </tr>

                <!-- Lista de solicitudes aprobadas (máximo 6) -->
                <tr *ngFor="let solicitud of clientesFiltrados">
                  <td class="id_solicitud text-center">{{ solicitud.id_solicitud }}</td>
                  <td class="id_solicitud text-center">{{ solicitud.cliente_id || 'N/A' }}</td>
                  <td>{{ getNombreCompleto(solicitud) }}</td>
                  <td>{{ formatearMoneda(solicitud.monto_aprobado) }}</td>
                  <!-- <td>{{ solicitud.tasa_fija_formateada || formatearTasaFija(solicitud.tasa_fija) }}</td> -->
                  <td>{{ convertirTasaAporcentaje(solicitud.tasa_fija) }}</td>
                  <td>{{ solicitud.aliado_nombre || 'Sin asignar' }}</td>
                  <td class="text-center">{{ formatearFecha(solicitud.fecha_aprobacion) }}</td>
                  <td class="actions-cell">
                    <div class="d-flex flex-column gap-1">

                      <!-- Botón Principal con estado condicional -->
                      <button [class]="getClaseBotonGenerarCredito(solicitud)"
                        [title]="getTooltipGenerarCredito(solicitud)" (click)="abrirModalPagare(solicitud)"
                        [disabled]="!solicitud.domiciliado || !puedeGenerarCredito(solicitud)" class="btn-action-main">
                        <i [class]="getIconoBotonGenerarCredito(solicitud)"></i>
                        {{ getTextoBotonGenerarCredito(solicitud) }}
                      </button>

                      <!-- Grupo de elementos secundarios -->
                      <div class="secondary-elements" *ngIf="!puedeGenerarCredito(solicitud)">

                        <!-- Botón Secundario: Ver Detalles -->
                        <button class="btn-action-secondary" (click)="verDetallesCreditoExistente(solicitud)"
                          title="Ver detalles completos del crédito existente">
                          <i class="fas fa-eye me-1"></i>
                          <span class="btn-text">Detalles</span>
                        </button>

                        <!-- Badge de Estado -->
                        <div class="status-badge">
                          <span class="badge"
                            [ngClass]="'badge-' + getBadgeColor(obtenerEstadoCreditoExistente(solicitud))">
                            <i class="fas fa-file-invoice-dollar me-1"></i>
                            #{{ obtenerIdCreditoExistente(solicitud) }} - {{ obtenerEstadoCreditoExistente(solicitud) }}
                          </span>
                        </div>

                      </div>

                      <!-- Badge: No Domiciliado -->
                      <div class="no-domiciliado-badge" *ngIf="!solicitud.domiciliado">
                        <span class="badge badge-warning">
                          <i class="fas fa-exclamation-circle me-1"></i>
                          Pendiente Domiciliación
                        </span>
                      </div>

                    </div>
                  </td>
                </tr>
              </tbody>
            </table>

            <!-- Contador de solicitudes -->
            <div class="mt-3 text-center">
              <span class="badge badge-info">
                Mostrando {{ clientesFiltrados.length }} de {{ solicitudesRecientes.length }} solicitudes recientes
              </span>
            </div>
          </div>

          <!-- Mensaje cuando no hay datos después de filtrar -->
          <div *ngIf="!cargando && haySolicitudes && clientesFiltrados.length === 0" class="no-data">
            <i class="fas fa-users fa-2x"></i>
            <p>No se encontraron clientes con los filtros aplicados</p>
          </div>
        </div>
      </div>

      <!-- Pestaña 2: Créditos Pendientes -->
      <div class="tab-pane fade" id="pendientes" role="tabpanel" aria-labelledby="pendientes-tab">
        <div class="table-container-vertical">
          <div class="tabla-header">
            <h3>CRÉDITOS PENDIENTES DE ENTREGA</h3>
            <div class="botones-filtros">
              <button class="btn btn-outline btn-sm" (click)="cargarCreditos()" [disabled]="cargandoCreditos">
                <i class="fas fa-sync-alt" [class.fa-spin]="cargandoCreditos"></i>
                {{ cargandoCreditos ? 'Cargando...' : 'Actualizar' }}
              </button>
            </div>
          </div>

          <div class="table-container-vertical">
            <table class="table">
              <thead>
                <tr>
                  <th class="text-center">ID CRÉDITO</th>
                  <th class="text-center">ID CLIENTE</th>
                  <th>NOMBRE COMPLETO</th>
                  <th class="text-center">MONTO TOTAL</th>
                  <th class="text-center">FECHA MINISTRACIÓN</th>
                  <th class="text-center">TIEMPO RESTANTE</th>
                  <th class="text-center">ACCIONES</th>
                </tr>
              </thead>
              <tbody>
                <!-- Estado de carga -->
                <tr *ngIf="cargandoCreditos">
                  <td colspan="7" class="text-center">
                    <i class="fas fa-spinner fa-spin"></i> Cargando créditos...
                  </td>
                </tr>

                <!-- Sin créditos pendientes -->
                <tr *ngIf="!cargandoCreditos && getCreditosPorEstado('PENDIENTE').length === 0">
                  <td colspan="7" class="text-center">
                    No hay créditos pendientes
                  </td>
                </tr>

                <!-- Lista de créditos pendientes -->
                <tr *ngFor="let credito of getCreditosPorEstado('PENDIENTE')"
                  [class.tiempo-critico]="getTiempoRestante(credito).esCritico"
                  [class.tiempo-advertencia]="getTiempoRestante(credito).esAdvertencia">
                  <td class="text-center fw-bold">{{ credito.id_credito }}</td>
                  <td class="text-center">
                    <span class="id_solicitud">{{ credito.cliente_id || 'N/A' }}</span>
                  </td>
                  <td>
                    <strong>{{ getNombreCompletoCredito(credito) }}</strong><br>
                    <small class="text-muted">
                      <i class="fas fa-id-card"></i> Solicitud: {{ credito.solicitud_id }}
                    </small>
                  </td>
                  <td class="text-center">
                    <span class="badge badge-primary">
                      {{ formatearMoneda(credito.total_a_pagar) }}
                    </span>
                  </td>
                  <td class="text-center">{{ formatearFecha(credito.fecha_ministracion) }}</td>
                  <td class="text-center">
                    <div class="temporizador-container" *ngIf="getTiempoRestante(credito).hayFecha">
                      <div class="temporizador" [ngClass]="{
                  'temporizador-normal': !getTiempoRestante(credito).esCritico && !getTiempoRestante(credito).esAdvertencia,
                  'temporizador-advertencia': getTiempoRestante(credito).esAdvertencia,
                  'temporizador-critico': getTiempoRestante(credito).esCritico
                }">
                        <i class="fas fa-clock"></i>
                        <span class="temporizador-texto">{{ getTiempoRestante(credito).texto }}</span>
                      </div>
                      <div class="progress" style="height: 4px;">
                        <div class="progress-bar" [ngClass]="{
                         'bg-success': getTiempoRestante(credito).porcentaje < 50,
                         'bg-warning': getTiempoRestante(credito).porcentaje >= 50 && getTiempoRestante(credito).porcentaje < 75,
                         'bg-danger': getTiempoRestante(credito).porcentaje >= 75
                       }" [style.width.%]="getTiempoRestante(credito).porcentaje">
                        </div>
                      </div>
                    </div>
                    <span *ngIf="!getTiempoRestante(credito).hayFecha" class="text-muted">
                      Sin fecha de ministración
                    </span>
                  </td>
                  <td class="text-center">
                    <div class="btn-group-vertical btn-group-sm text-center" role="group">
                      <!-- BOTÓN PARA GENERAR PAGARÉ EN CRÉDITOS PENDIENTES -->
                      <button class="btn btn-primary btn-sm mb-1 text-center"
                        (click)="abrirModalGenerarPagareDesdeCredito(credito)">
                        <i class="fas fa-file-contract"></i> Pagaré
                      </button>
                      <button class="btn btn-success btn-sm mb-1 text-center" (click)="marcarComoEntregado(credito)">
                        <i class="fas fa-check-circle"></i> Entregar
                      </button>
                      <button class="btn btn-danger btn-sm mb-1 text-center" (click)="marcarComoDevolucion(credito)">
                        <i class="fas fa-undo"></i> Devolución
                      </button>
                    </div>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>


      <!-- Pestaña 3: Créditos Entregados -->
      <div class="tab-pane fade" id="entregados" role="tabpanel" aria-labelledby="entregados-tab">
        <div class="table-container-vertical">
          <div class="tabla-header">
            <h3>CRÉDITOS ENTREGADOS</h3>
            <div class="botones-filtros">
              <button class="btn btn-outline btn-sm" (click)="cargarCreditos()" [disabled]="cargandoCreditos">
                <i class="fas fa-sync-alt" [class.fa-spin]="cargandoCreditos"></i>
                {{ cargandoCreditos ? 'Cargando...' : 'Actualizar' }}
              </button>
            </div>
          </div>

          <div class="table-container-vertical">
            <table class="table">
              <thead>
                <tr>
                  <th class="text-center">ID CRÉDITO</th>
                  <th class="text-center">CLIENTE</th>
                  <th>NOMBRE COMPLETO</th>
                  <th class="text-center">MONTO TOTAL</th>
                  <!-- <th class="text-center">FECHA MINISTRACIÓN</th> -->
                  <th class="text-center">FECHA ENTREGA</th>
                  <th class="text-center">ALIADO</th>
                </tr>
              </thead>
              <tbody>
                <!-- Estado de carga -->
                <tr *ngIf="cargandoCreditos">
                  <td colspan="7" class="text-center">
                    <i class="fas fa-spinner fa-spin"></i> Cargando créditos...
                  </td>
                </tr>

                <!-- Sin créditos entregados -->
                <tr *ngIf="!cargandoCreditos && getCreditosPorEstado('ENTREGADO').length === 0">
                  <td colspan="7" class="text-center">
                    No hay créditos entregados
                  </td>
                </tr>

                <!-- Lista de créditos entregados -->
                <tr *ngFor="let credito of getCreditosPorEstado('ENTREGADO')">
                  <td class="text-center fw-bold">{{ credito.id_credito }}</td>
                  <td class="text-center">
                    <span class="id_solicitud">{{ credito.cliente_id || 'N/A' }}</span>
                  </td>
                  <td>
                    <strong>{{ getNombreCompletoCredito(credito) }}</strong><br>
                    <small class="text-muted">
                      <i class="fas fa-id-card"></i> Solicitud: {{ credito.solicitud_id }}
                    </small>
                  </td>
                  <td class="text-center">
                    <span class="badge badge-primary">
                      {{ formatearMoneda(credito.total_a_pagar) }}
                    </span>
                  </td>
                  <td class="text-center">{{ formatearFecha(credito.fecha_ministracion) }}</td>
                  <!-- <td class="text-center">{{ formatearFecha(credito.fecha_actualizacion) ||
                    formatearFecha(credito.fecha_entrega) || 'No registrada' }}</td> -->
                  <td class="text-center">
                    <span class="badge badge-secondary">{{ credito.nom_aliado || 'Sin aliado' }}</span>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- Pestaña 4: Créditos en Devolución -->
      <div class="tab-pane fade" id="devolucion" role="tabpanel" aria-labelledby="devolucion-tab">
        <div class="table-container-vertical">
          <div class="tabla-header">
            <h3>CRÉDITOS EN DEVOLUCIÓN</h3>
            <div class="botones-filtros">
              <button class="btn btn-outline btn-sm" (click)="cargarCreditos()" [disabled]="cargandoCreditos">
                <i class="fas fa-sync-alt" [class.fa-spin]="cargandoCreditos"></i>
                {{ cargandoCreditos ? 'Cargando...' : 'Actualizar' }}
              </button>
            </div>
          </div>

          <div class="table-container-vertical">
            <table class="table">
              <thead>
                <tr>
                  <th class="text-center">ID CRÉDITO</th>
                  <th class="text-center">CLIENTE</th>
                  <th>NOMBRE COMPLETO</th>
                  <th class="text-center">MONTO TOTAL</th>
                  <th class="text-center">ALIADO</th>
                  <th class="text-center">ACCIONES</th>
                </tr>
              </thead>
              <tbody>
                <!-- Estado de carga -->
                <tr *ngIf="cargandoCreditos">
                  <td colspan="7" class="text-center">
                    <i class="fas fa-spinner fa-spin"></i> Cargando créditos...
                  </td>
                </tr>

                <!-- Sin créditos en devolución -->
                <tr *ngIf="!cargandoCreditos && getCreditosPorEstado('DEVOLUCION').length === 0">
                  <td colspan="7" class="text-center">
                    No hay créditos en devolución
                  </td>
                </tr>

                <!-- Lista de créditos en devolución -->
                <tr *ngFor="let credito of getCreditosPorEstado('DEVOLUCION')">
                  <td class="text-center fw-bold">{{ credito.id_credito }}</td>
                  <td class="text-center">
                    <span class="id_solicitud">{{ credito.cliente_id || 'N/A' }}</span>
                  </td>
                  <td>
                    <strong>{{ getNombreCompletoCredito(credito) }}</strong><br>
                    <small class="text-muted">
                      <i class="fas fa-id-card"></i> Solicitud: {{ credito.solicitud_id }}
                    </small>
                  </td>
                  <td class="text-center">
                    <span class="badge badge-primary">
                      {{ formatearMoneda(credito.total_a_pagar) }}
                    </span>
                  </td>
                  <td class="text-center">
                    <span class="badge badge-secondary">{{ credito.nom_aliado || 'Sin aliado' }}</span>
                  </td>
                  <td class="text-center">
                    <!-- NUEVO BOTÓN PARA EDITAR FECHAS -->
                    <button class="btn btn-warning btn-sm me-2" (click)="editarFechasCredito(credito)"
                      title="Editar fechas antes de marcar como pendiente">
                      <i class="fas fa-calendar-edit"></i> Editar Fechas
                    </button>

                    <button class="btn btn-success btn-sm" (click)="marcarComoPendienteConFecha(credito)">
                      <i class="fas fa-check-circle"></i> Marcar como Pendiente
                    </button>

                    <button class="btn btn-danger btn-sm ms-1" (click)="cancelarCredito(credito)">
                      <i class="fas fa-ban"></i> Cancelar
                    </button>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- MODAL PARA GENERAR CRÉDITO -->
<div class="modal-backdrop" *ngIf="modalGenerarCreditoAbierto">
  <div class="modal-container modal-md">
    <div class="modal-header">
      <h3>GENERAR CRÉDITO - {{ solicitudSeleccionada?.nombre_cliente }} {{ solicitudSeleccionada?.app_cliente }}</h3>
      <button class="btn-close" (click)="cerrarModalGenerarCredito()">&times;</button>
    </div>

    <div class="modal-body">
      <div class="form-section">
        <h4>Configurar Fechas del Crédito</h4>

        <div class="row">
          <div class="col-md-6">
            <div class="form-group">
              <label><strong>Fecha de Ministración *</strong></label>
              <input type="date" class="form-control" [(ngModel)]="fechaMinistracion" required>
            </div>
          </div>

          <div class="col-md-6">
            <div class="form-group">
              <label><strong>Fecha Primer Pago *</strong></label>
              <input type="date" class="form-control" [(ngModel)]="fechaPrimerPago" required>
              <small class="text-muted">Día de pago: {{solicitudSeleccionada?.dia_pago}}</small>
            </div>
          </div>
        </div>

        <!-- Resumen del crédito -->
        <div class="resumen-credito mt-3">
          <h5>Resumen del Crédito</h5>
           <div class="row">
            <div class="col-md-6">
              <p><strong>Cliente:</strong> {{ getNombreCompleto(solicitudSeleccionada) }}</p>
              <p><strong>Monto Aprobado:</strong> {{ formatearMoneda(solicitudSeleccionada?.monto_aprobado) }}</p>
              <p><strong>Aliado:</strong> {{ solicitudSeleccionada?.aliado_nombre }}</p>
            </div>
            <div class="col-md-6">
              <p><strong>Tasa de Interés:</strong> {{ convertirTasaAporcentaje(solicitudSeleccionada?.tasa_fija)}}</p>
              <p><strong>Tipo de Crédito:</strong> {{ solicitudSeleccionada?.tipo_credito }}</p>
              <p><strong>ID Solicitud:</strong> {{ solicitudSeleccionada?.id_solicitud }}</p>
            </div>
          </div>
        </div>
      </div>
      <div class="resumen-credito">
        <h5>Resumen del Crédito</h5>
        <table class="table table-sm table-bordered">
          <tr>
            <td class="resumen-credito">Capital:</td>
            <td class="text-right">{{ formatearMoneda(totalCapital) }}</td>
          </tr>
          <tr>
            <td>Interés ({{ convertirTasaAporcentaje(solicitudSeleccionada?.tasa_fija || 0) }}):</td>
            <!-- <td>{{ solicitudSeleccionada.tasa_fija_formateada || (solicitudSeleccionada.tasa_fija ? ((solicitudSeleccionada.tasa_fija * 100).toFixed(0)) + '%' : '0%')}}</td> -->
            <td class="text-right">{{ formatearMoneda(totalInteres) }}</td>
            <!-- <td>{{ convertirTasaAporcentaje(solicitud.tasa_fija) }}</td> -->
          </tr>
          <tr class="total-row">
            <td>TOTAL A PAGAR:</td>
            <td class="text-right">{{ formatearMoneda(totalAPagar) }}</td>
          </tr>
          <tr>
            <td class="pago_semanal">Pago Semanal (16 semanas):</td>
            <td class="text-right">{{ formatearMoneda(pagoSemanal) }}</td>
          </tr>
          <!-- Pago inicial -->
          <tr *ngIf="seguro">
            <td>Seguro:</td>
            <td class="text-right">{{ formatearMoneda(totalSeguro) }}</td>
          </tr>
          <tr>
            <td>Garantía (10%):</td>
            <td class="text-right">{{ formatearMoneda(totalGarantia) }}</td>
          </tr>
          <tr class="total-row">
            <td>PAGO INICIAL:</td>
            <td class="text-right">{{ formatearMoneda(pagoInicial) }}</td>
          </tr>
        </table>
      </div>

    </div>


    <div class="modal-footer">
      <button class="btn btn-outline" (click)="cerrarModalGenerarCredito()">Cancelar</button>
      <button class="btn btn-primary" (click)="crearCredito()"
        [disabled]="!fechaMinistracion || !fechaPrimerPago || procesandoGeneracion">
        <i class="fas" [ngClass]="procesandoGeneracion ? 'fa-spinner fa-spin' : 'fa-save'"></i>
        {{ procesandoGeneracion ? 'Creando...' : 'Generar Crédito' }}
      </button>
    </div>
  </div>
</div>


<!-- MODAL PARA GENERAR PAGARÉ -->
<div class="modal-backdrop" *ngIf="modalGenerarPagareAbierto">
  <div class="modal-container modal-lg">
    <!-- Cabecera del modal -->
    <div class="modal-header">
      <h5 class="modal-title">
        <i class="fas fa-file-contract me-2"></i>
        Generar Documentos - {{getNombreCompleto(solicitudSeleccionada)}}
      </h5>
      <button type="button" class="btn-close" (click)="cerrarModalGenerarPagare()">&times;</button>
    </div>

    <!-- Cuerpo del modal -->
    <div class="modal-body">
      <!-- Controles de navegación entre documentos -->
      <div class="document-nav mb-4">
        <div class="nav-buttons">
          <button class="btn btn-outline-primary" 
                  [class.active]="documentoActual === 'pagare'"
                  (click)="cambiarDocumento('pagare')"
                  [disabled]="generandoPagare">
            <i class="fas fa-file-contract me-2"></i>
            Pagaré
          </button>
          
          <button class="btn btn-outline-primary" 
                  [class.active]="documentoActual === 'hojaControl'"
                  (click)="cambiarDocumento('hojaControl')"
                  [disabled]="generandoHojaControl">
            <i class="fas fa-clipboard-list me-2"></i>
            Hoja de Control
          </button>
        </div>
      </div>

      <!-- Área de vista previa -->
      <div class="preview-area">
        <!-- Loader general del documento -->
        <div *ngIf="documentoCargando" class="loader-overlay">
          <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Cargando...</span>
          </div>
          <p class="mt-2">Generando documento...</p>
        </div>

        <!-- Vista previa del PDF -->
        <div *ngIf="!documentoCargando && (pdfPagareUrl || pdfHojaControlUrl)" class="pdf-preview">
          <iframe 
            [src]="documentoActual === 'pagare' ? pdfPagareUrl : pdfHojaControlUrl" 
            width="100%" 
            height="500px"
            style="border: 1px solid #dee2e6; border-radius: 4px;">
          </iframe>
        </div>

        <!-- Mensaje cuando no hay documentos generados -->
        <div *ngIf="!documentoCargando && !pdfPagareUrl && !pdfHojaControlUrl" class="no-document">
          <i class="fas fa-file-pdf fa-3x text-muted mb-3"></i>
          <p>Presiona "Generar" para crear el documento</p>
        </div>
      </div>

      <!-- Botones de acción -->
      <div class="modal-footer">
        <!-- BOTONES DE GENERACIÓN INICIAL -->
        <div class="action-buttons" *ngIf="!documentosGenerados">
          <button class="btn btn-primary" 
                  (click)="generarVistaPreviaPagare()"
                  [disabled]="generandoPagare || !creditoRecienCreado">
            <i *ngIf="generandoPagare" class="fas fa-spinner fa-spin me-2"></i>
            <i *ngIf="!generandoPagare" class="fas fa-file-contract me-2"></i>
            {{ generandoPagare ? 'Generando...' : 'Generar Pagaré' }}
          </button>

          <button class="btn btn-success" 
                  (click)="generarVistaPreviaHojaControl()"
                  [disabled]="generandoHojaControl || !creditoRecienCreado">
            <i *ngIf="generandoHojaControl" class="fas fa-spinner fa-spin me-2"></i>
            <i *ngIf="!generandoHojaControl" class="fas fa-clipboard-list me-2"></i>
            {{ generandoHojaControl ? 'Generando...' : 'Generar Hoja Control' }}
          </button>
        </div>

        <!-- BOTONES DE RE-GENERACIÓN Y DESCARGA -->
        <div class="regenerar-descargar-buttons" *ngIf="documentosGenerados">
          <!-- Botón para Volver a Generar Todo -->
          <button class="btn btn-warning me-2" 
                  (click)="regenerarTodosDocumentos()"
                  [disabled]="generandoPagare || generandoHojaControl">
            <i *ngIf="generandoPagare || generandoHojaControl" class="fas fa-spinner fa-spin me-2"></i>
            <i *ngIf="!generandoPagare && !generandoHojaControl" class="fas fa-redo me-2"></i>
            {{ (generandoPagare || generandoHojaControl) ? 'Regenerando...' : 'Volver a Generar Todo' }}
          </button>

          <!-- Botones de Descarga -->
          <div class="btn-group me-2">
            <button class="btn btn-outline-primary" 
                    (click)="descargarPagare()"
                    [disabled]="generandoPagare">
              <i *ngIf="generandoPagare" class="fas fa-spinner fa-spin me-2"></i>
              <i *ngIf="!generandoPagare" class="fas fa-download me-2"></i>
              Pagaré
            </button>

            <button class="btn btn-outline-success" 
                    (click)="descargarHojaControl()"
                    [disabled]="generandoHojaControl">
              <i *ngIf="generandoHojaControl" class="fas fa-spinner fa-spin me-2"></i>
              <i *ngIf="!generandoHojaControl" class="fas fa-download me-2"></i>
              Hoja Control
            </button>

            <button class="btn btn-info" 
                    (click)="descargarAmbosDocumentos()"
                    [disabled]="generandoPagare || generandoHojaControl">
              <i *ngIf="generandoPagare || generandoHojaControl" class="fas fa-spinner fa-spin me-2"></i>
              <i *ngIf="!generandoPagare && !generandoHojaControl" class="fas fa-file-archive me-2"></i>
              Ambos
            </button>
          </div>
        </div>

        <!-- Botón Cerrar -->
        <button class="btn btn-secondary" (click)="cerrarModalGenerarPagare()">
          <i class="fas fa-times me-2"></i>
          Cerrar
        </button>
      </div>
    </div>
  </div>
</div>


<!-- MODAL PARA VER DETALLES DEL CRÉDITO EXISTENTE -->
<div *ngIf="modalEditarFechasAbierto" class="modal fade show" style="display: block; background-color: rgba(0,0,0,0.5);" tabindex="-1" role="dialog">
  <div class="modal-dialog modal-dialog-centered" role="document">
    <div class="modal-content">
      <div class="modal-header bg-warning text-white">
        <h5 class="modal-title">
          <i class="fas fa-calendar-edit me-2"></i>
          Editar Fechas del Crédito
        </h5>
        <button type="button" class="btn-close btn-close-white" (click)="cerrarModalEditarFechas()"></button>
      </div>
      
      <div class="modal-body">
        <div *ngIf="creditoSeleccionado">
          <div class="alert alert-info mb-3">
            <i class="fas fa-info-circle me-2"></i>
            Editando fechas para el crédito <strong>#{{creditoSeleccionado.id_credito}}</strong> 
            del cliente <strong>{{getNombreCompletoCredito(creditoSeleccionado)}}</strong>
          </div>
          
          <div class="mb-3">
            <label for="fechaMinistracion" class="form-label">
              <i class="fas fa-calendar-plus me-1"></i>
              Fecha de Ministración
            </label>
            <input type="date" 
                   id="fechaMinistracion" 
                   class="form-control"
                   [(ngModel)]="nuevaFechaMinistracion"
                   [min]="getFechaMinima()">
            <small class="text-muted">
              Fecha actual: {{formatearFecha(creditoSeleccionado.fecha_ministracion)}}
            </small>
          </div>
          
          <div class="mb-3">
            <label for="fechaPrimerPago" class="form-label">
              <i class="fas fa-calendar-check me-1"></i>
              Fecha de Primer Pago
            </label>
            <input type="date" 
                   id="fechaPrimerPago" 
                   class="form-control"
                   [(ngModel)]="nuevaFechaPrimerPago"
                   [min]="nuevaFechaMinistracion || getFechaMinima()">
            <small class="text-muted">
              Fecha actual: {{formatearFecha(creditoSeleccionado.fecha_primer_pago)}}
            </small>
          </div>
          
          <div class="alert alert-warning">
            <i class="fas fa-exclamation-triangle me-2"></i>
            <strong>Importante:</strong> Al actualizar las fechas, el temporizador de 48 horas se reiniciará desde la nueva fecha de ministración.
          </div>
        </div>
      </div>
      
      <div class="modal-footer">
        <button type="button" 
                class="btn btn-secondary" 
                (click)="cerrarModalEditarFechas()"
                [disabled]="procesandoEntrega">
          Cancelar
        </button>
        
        <button type="button" 
                class="btn btn-success" 
                (click)="guardarFechasCredito()"
                [disabled]="procesandoEntrega || !nuevaFechaMinistracion || !nuevaFechaPrimerPago">
          <i class="fas fa-save me-1"></i>
          {{procesandoEntrega ? 'Guardando...' : 'Guardar Cambios'}}
        </button>
      </div>
    </div>
  </div>
</div>
