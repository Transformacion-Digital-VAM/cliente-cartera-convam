<div class="admin-container">
  <!-- Migajas de Pan -->
  <nav class="breadcrumb-nav" aria-label="Migajas de pan">
    <ol class="breadcrumb">
      <li class="breadcrumb-item">
        <a href="/dashboard" class="breadcrumb-link">INICIO</a>
      </li>
      <li class="breadcrumb-item active" aria-current="page">
        GESTIÓN DE PAGOS
      </li>
    </ol>
  </nav>

  <!-- Encabezado -->
  <header class="admin-header">
    <h1 class="reset-title">CARTERA - GESTIÓN DE PAGOS</h1>
  </header>

  <!-- Contenido principal -->
  <div class="admin-content">
    <!-- Barra de búsqueda y filtros -->
    <div class="filtros-section">
      <div class="filtros-card">
        <h3>Filtrar Créditos</h3>
        <div class="filtros-form">
          <div class="form-group">
            <label class="form-label">ALIADO</label>
            <select class="form-control" [(ngModel)]="filtroAliado">
              <option value="">TODOS LOS ALIADOS</option>
              <option *ngFor="let aliado of aliados" [value]="aliado.id_aliado">
                {{ aliado.nom_aliado.trim() }}
              </option>
            </select>
          </div>
          <div class="form-group">
            <label class="form-label">NOMBRE DEL CLIENTE</label>
            <input type="text" class="form-control" placeholder="Buscar por nombre..." 
                   [(ngModel)]="filtroCliente">
          </div>
          <div class="botones-filtros">
            <button class="btn btn-primary" (click)="buscar()">
              <i class="fas fa-search"></i> BUSCAR
            </button>
            <button class="btn btn-outline" (click)="limpiarFiltros()">
              <i class="fas fa-undo"></i> LIMPIAR
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Tabla de créditos -->
    <section class="tabla-section-vertical">
      <div class="tabla-header">
        <h3>ESTADO DE PAGOS</h3>
        <div class="botones-filtros">
          <button class="btn btn-outline btn-sm" (click)="cargarCreditos()" [disabled]="cargando">
            <i class="fas fa-sync-alt" [class.fa-spin]="cargando"></i> 
            {{ cargando ? 'Cargando...' : 'ACTUALIZAR' }}
          </button>
        </div>
      </div>

      <div class="table-container-vertical">
        <table class="table">
          <thead>
            <tr>
              <th></th>
              <th>CLIENTE</th>
              <th>ALIADO</th>
              <th>TOTAL A PAGAR</th>
              <th>DÍA DE PAGO</th>
              <th>NO. PAGO</th>
              <th>MONTO SEMANAL</th>
              <th>PRÓXIMA FECHA</th>
              <!-- <th>MORA PAGADA</th> -->
              <th>TOTAL PAGADO</th>
              <th>SALDO PENDIENTE</th>
              <th>PAGOS REALIZADOS</th>
              <th>ESTADO</th>
              <th>DÍAS ATRASO</th>
              <th>SEMANAS ATRASO</th>
              <!-- <th>CARTERA ATRASADA</th>
              <th>MORA ACUMULADA</th> -->
              <!-- <th>MORA PENDIENTE</th> -->
              <th>TOTAL ATRASADO</th>
              <th>ACCIONES</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngIf="cargando">
              <td colspan="20" class="text-center">
                <i class="fas fa-spinner fa-spin"></i> Cargando créditos...
              </td>
            </tr>
            
            <tr *ngIf="!cargando && !hayCreditos">
              <td colspan="20" class="text-center">
                No hay créditos entregados
              </td>
            </tr>
            
            <ng-container *ngFor="let credito of creditosFiltrados">
              <!-- Fila principal con color según estado -->
              <tr class="clickable-row" 
                  [ngClass]="getEstadoPago(credito).filaClase"
                  (click)="toggleFilaDetalle(credito.id_credito)">
                <td>
                  <i class="fas icon-detalles" 
                     [class.fa-chevron-right]="filaExpandida !== credito.id_credito"
                     [class.fa-chevron-down]="filaExpandida === credito.id_credito"></i>
                </td>
                <td>{{ getNombreCliente(credito) }}</td>
                <td>{{ getNombreAliado(credito.aliado_id) }}</td>
                <td>{{ formatearMoneda(credito.total_a_pagar) }}</td>
                <td>{{ getDiaPago(credito) }}</td>
                <td>{{ calcularProximoNumeroPago(credito) }}/16</td>
                <td>{{ formatearMoneda(calcularPagoSemanal(credito)) }}</td>
                <td>{{ formatearProximaFechaPago(credito) }}</td>
                <!-- <td>{{ formatearMoneda(calcularMoratorioTotal(credito)) }}</td> -->
                <td>{{ formatearMoneda(calcularTotalPagado(credito)) }}</td>
                <td>{{ formatearMoneda(credito.saldo_pendiente) }}</td>
                <td>
                  {{ calcularPagosRealizados(credito) }}/16
                  <small class="text-muted">({{ calcularPagosPendientes(credito) }} PENDIENTES)</small>
                </td>
                <td [ngClass]="getEstadoPago(credito).clase">
                  {{ getEstadoPago(credito).texto }}
                </td>
                <td>{{ calcularDiasAtraso(credito) }}</td>
                <td>{{ calcularSemanasAtraso(credito) }}</td>
                <!-- <td>{{ formatearMoneda(calcularCarteraAtrasada(credito)) }}</td>
                <td>{{ formatearMoneda(calcularMoraAcumulada(credito)) }}</td>
                <td [ngClass]="{'text-danger': calcularMoraPendiente(credito) > 0}">
                  {{ formatearMoneda(calcularMoraPendiente(credito)) }}
                </td> -->
                <td [ngClass]="{'text-danger': calcularTotalAtrasado(credito) > 0}">
                  {{ formatearMoneda(calcularTotalAtrasado(credito)) }}
                </td>
                <td class="actions-cell">
                  <button class="btn btn-success btn-sm" (click)="abrirModalSeleccion(credito); $event.stopPropagation()">
                    <i class="fas fa-money-bill-wave"></i> PAGO
                  </button>
                </td>
              </tr>
              
              <!-- Fila expandible con detalles de pagos -->
              <tr *ngIf="filaExpandida === credito.id_credito" class="detalle-row">
                <td colspan="20">
                  <div class="detalle-pagos-container">
                    <h5><i class="fas fa-list-alt icon-detalles"></i> DETALLE DE PAGOS</h5>
                    
                    <div class="table-responsive">
                      <table class="table table-sm table-detalle">
                        <thead>
                          <tr>
                            <th>No. PAGO</th>
                            <th>FECHA</th>
                            <th>TOTAL PAGADO</th>
                            <th>CAPITAL</th>
                            <th>INTERESES</th>
                            <th>MORA</th>
                            <th>TIPO</th>
                          </tr>
                        </thead>
                        <tbody>
                          <tr *ngIf="getDetallesPagos(credito.id_credito).length === 0">
                            <td colspan="7" class="text-center text-muted">
                              No hay pagos registrados
                            </td>
                          </tr>
                          <tr *ngFor="let detalle of getDetallesPagos(credito.id_credito)">
                            <td>{{ detalle.numeroPago }}</td>
                            <td>{{ formatearFecha(detalle.fecha) }}</td>
                            <td>{{ formatearMoneda(detalle.montoTotal) }}</td>
                            <td>{{ formatearMoneda(detalle.capital) }}</td>
                            <td>{{ formatearMoneda(detalle.intereses) }}</td>
                            <td>{{ formatearMoneda(detalle.mora) }}</td>
                            <td>
                              <span class="badge" 
                                    [class.badge-success]="detalle.tipoPago.includes('NORMAL')"
                                    [class.badge-warning]="detalle.tipoPago.includes('COMPLEMENTO')"
                                    [class.badge-info]="detalle.tipoPago.includes('ADICIONAL')">
                                {{ detalle.tipoPago }}
                              </span>
                            </td>
                          </tr>
                        </tbody>
                      </table>
                    </div>
                  </div>
                </td>
              </tr>
            </ng-container>
          </tbody>
        </table>
      </div>

      <div *ngIf="!cargando && hayCreditos && creditosFiltrados.length === 0" class="no-data">
        <i class="fas fa-file-invoice-dollar fa-2x"></i>
        <p>No se encontraron créditos con los filtros aplicados</p>
      </div>
    </section>
  </div>
</div>

<!-- MODAL DE SELECCIÓN DE TIPO DE PAGO -->
<div class="modal-overlay" *ngIf="modalSeleccionAbierto">
  <div class="modal-content modal-seleccion">
    <div class="modal-header">
      <div class="modal-header-content">
        <div class="modal-icon">
          <i class="fas fa-hand-holding-usd"></i>
        </div>
        <div class="modal-header-text">
          <h3 class="modal-title">SELECCIONAR TIPO DE PAGO</h3>
          <p class="modal-subtitle">{{ getNombreCliente(creditoSeleccionado) }}</p>
        </div>
      </div>
      <button class="modal-close" (click)="cerrarModalSeleccion()">
        <i class="fas fa-times"></i>
      </button>
    </div>

    <div class="modal-body">
      <!-- Información detallada -->
      <div class="info-section">
        <h4><i class="fas fa-exclamation-triangle"></i> SITUACIÓN ACTUAL</h4>
        <div class="info-grid">
          <div class="info-item">
            <strong>Próxima Fecha de Pago:</strong>
            <span [ngClass]="{'text-success': diasAtraso === 0, 'text-danger': diasAtraso > 0}">
              {{ formatearFecha(proximaFechaPago?.toISOString() || '') }}
            </span>
          </div>
          <div class="info-item">
            <strong>Días de Atraso:</strong>
            <span [ngClass]="{'text-success': diasAtraso === 0, 'text-danger': diasAtraso > 0}">
              {{ diasAtraso }} días
            </span>
          </div>
          <div class="info-item">
            <strong>Semanas Atrasadas:</strong>
            <span class="text-danger">{{ semanasAtraso }}</span>
          </div>
          <div class="info-item">
            <strong>Cartera Atrasada:</strong>
            <span>{{ formatearMoneda(carteraAtrasada) }}</span>
          </div>
          <!-- <div class="info-item">
            <strong>Mora Acumulada:</strong>
            <span class="text-danger">{{ formatearMoneda(moraAcumulada) }}</span>
          </div>
          <div class="info-item">
            <strong>Mora Pagada:</strong>
            <span>{{ formatearMoneda(calcularMoratorioTotal(creditoSeleccionado)) }}</span>
          </div> -->
          <div class="info-item">
            <strong>Mora Pendiente:</strong>
            <span class="text-danger">{{ formatearMoneda(calcularMoraPendiente(creditoSeleccionado)) }}</span>
          </div>
          <div class="info-item">
            <strong>Total Atrasado:</strong>
            <span class="monto-total text-danger">{{ formatearMoneda(totalAtrasado) }}</span>
          </div>
          <div class="info-item">
            <strong>Saldo Pendiente:</strong>
            <span class="monto-total">{{ formatearMoneda(creditoSeleccionado.saldo_pendiente) }}</span>
          </div>
          <div class="info-item">
            <strong>Pago Semanal:</strong>
            <span>{{ formatearMoneda(creditoSeleccionado.pago_semanal) }}</span>
          </div>
          <div class="info-item">
            <strong>Próximo Pago N°:</strong>
            <span>{{ calcularProximoNumeroPago(creditoSeleccionado) }}/16</span>
          </div>
          <div class="info-item">
            <strong>Pagos Completados:</strong>
            <span>{{ calcularPagosRealizados(creditoSeleccionado) }}</span>
          </div>
        </div>
      </div>

      <!-- Opciones de pago -->
      <div class="opciones-pago">
        <div class="opcion-pago" (click)="abrirModalPago('NORMAL')">
          <div class="opcion-icon">
            <i class="fas fa-calendar-week"></i>
          </div>
          <div class="opcion-content">
            <h4>PAGO NORMAL</h4>
            <p>Pago semanal correspondiente</p>
            <div class="opcion-details">
              <span class="monto-sugerido">
                {{ formatearMoneda(creditoSeleccionado.pago_semanal) }}
              </span>
              <span class="text-danger" *ngIf="calcularMoraPendiente(creditoSeleccionado) > 0">
                + {{ formatearMoneda(calcularMoraPendiente(creditoSeleccionado)) }} de mora
              </span>
            </div>
          </div>
          <div class="opcion-arrow">
            <i class="fas fa-chevron-right"></i>
          </div>
        </div>

        <div class="opcion-pago" (click)="abrirModalPago('COMPLEMENTO')">
          <div class="opcion-icon">
            <i class="fas fa-clock"></i>
          </div>
          <div class="opcion-content">
            <h4>COMPLEMENTO</h4>
            <p>Pagar semanas atrasadas y mora</p>
            <div class="opcion-details">
              <span class="text-danger" *ngIf="semanasAtraso > 0">
                {{ semanasAtraso }} semana(s) atrasada(s)
              </span>
              <!-- <span class="text-danger" *ngIf="calcularMoraPendiente(creditoSeleccionado) > 0">
                {{ formatearMoneda(calcularMoraPendiente(creditoSeleccionado)) }} de mora
              </span> -->
            </div>
          </div>
          <div class="opcion-arrow">
            <i class="fas fa-chevron-right"></i>
          </div>
        </div>

        <div class="opcion-pago" (click)="abrirModalPago('ADICIONAL')">
          <div class="opcion-icon">
            <i class="fas fa-plus-circle"></i>
          </div>
          <div class="opcion-content">
            <h4>ADICIONAL</h4>
            <p>Pago extra para reducir saldo</p>
            <div class="opcion-details">
              <span class="text-success">Aplica directamente a capital</span>
            </div>
          </div>
          <div class="opcion-arrow">
            <i class="fas fa-chevron-right"></i>
          </div>
        </div>
      </div>
    </div>

    <div class="modal-footer">
      <button class="btn btn-secondary" (click)="cerrarModalSeleccion()">
        <i class="fas fa-times"></i> CANCELAR
      </button>
    </div>
  </div>
</div>

<!-- MODAL DE PAGO -->
<div class="modal-overlay" *ngIf="modalPagoAbierto">
  <div class="modal-content">
    <div class="modal-header">
      <div class="modal-header-content">
        <div class="modal-icon" [ngClass]="{
          'text-success': tipoPago === 'NORMAL',
          'text-warning': tipoPago === 'COMPLEMENTO',
          'text-info': tipoPago === 'ADICIONAL'
        }">
          <i class="fas" 
             [class.fa-calendar-week]="tipoPago === 'NORMAL'"
             [class.fa-clock]="tipoPago === 'COMPLEMENTO'"
             [class.fa-plus-circle]="tipoPago === 'ADICIONAL'"></i>
        </div>
        <div class="modal-header-text">
          <h3 class="modal-title">{{ tipoPago }}</h3>
          <p class="modal-subtitle">{{ getNombreCliente(creditoSeleccionado) }}</p>
        </div>
      </div>
      <button class="modal-close" (click)="cerrarModalPago()" [disabled]="procesandoPago">
        <i class="fas fa-times"></i>
      </button>
    </div>

    <div class="modal-body">
      <!-- Información de situación actual -->
      <div class="info-section">
        <h4><i class="fas fa-exclamation-triangle"></i> SITUACIÓN ACTUAL</h4>
        <div class="info-grid">
          <div class="info-item">
            <strong>Próxima Fecha:</strong>
            <span>{{ formatearFecha(proximaFechaPago?.toISOString() || '') }}</span>
          </div>
          <div class="info-item">
            <strong>Días de Atraso:</strong>
            <span [ngClass]="{'text-success': diasAtraso === 0, 'text-danger': diasAtraso > 0}">
              {{ diasAtraso }} días
            </span>
          </div>
          <div class="info-item">
            <strong>Semanas Atrasadas:</strong>
            <span class="text-danger">{{ semanasAtraso }}</span>
          </div>
          <div class="info-item">
            <strong>Cartera Atrasada:</strong>
            <span>{{ formatearMoneda(carteraAtrasada) }}</span>
          </div>
          <div class="info-item">
            <strong>Mora Acumulada:</strong>
            <span class="text-danger">{{ formatearMoneda(moraAcumulada) }}</span>
          </div>
          <div class="info-item">
            <strong>Mora Pendiente:</strong>
            <span class="text-danger">{{ formatearMoneda(calcularMoraPendiente(creditoSeleccionado)) }}</span>
          </div>
          <div class="info-item">
            <strong>Saldo Pendiente:</strong>
            <span class="monto-total">{{ formatearMoneda(creditoSeleccionado.saldo_pendiente) }}</span>
          </div>
          <div class="info-item">
            <strong>Próximo Pago N°:</strong>
            <span>{{ calcularProximoNumeroPago(creditoSeleccionado) }}/16</span>
          </div>
        </div>
      </div>

      <!-- Formulario de pago -->
      <div class="form-section">
        <div class="form-grid">
          <!-- NUEVO: Selector de número de semana/pago -->
          <div class="form-group full-width">
            <label class="form-label">
              <i class="fas fa-calendar-alt"></i> SEMANA/NÚMERO DE PAGO * 
              <small class="text-muted">(Seleccione la semana a la que aplicará este pago)</small>
            </label>
            <select class="form-control" 
                    [(ngModel)]="numeroPagoSeleccionado"
                    [disabled]="procesandoPago">
              <option *ngFor="let num of obtenerSemanasDisponibles()" 
                      [value]="num"
                      [disabled]="getEstadoSemana(num).disabled">
                Semana {{ num }}/16 - {{ getEstadoSemana(num).texto }}
              </option>
            </select>
            <small class="form-text text-info">
              <i class="fas fa-info-circle"></i>
              <span *ngIf="numeroPagoSeleccionado === calcularProximoNumeroPago(creditoSeleccionado)">
                Esta es la siguiente semana que debe pagarse
              </span>
              <span *ngIf="numeroPagoSeleccionado < calcularProximoNumeroPago(creditoSeleccionado)">
                Esta semana ya fue pagada - puede aplicar pagos adicionales o correcciones
              </span>
              <span *ngIf="numeroPagoSeleccionado > calcularProximoNumeroPago(creditoSeleccionado)">
                Esta es una semana futura - asegúrese de que es correcto
              </span>
            </small>
          </div>

          <div class="form-group">
            <label class="form-label">MONTO DEL PAGO *</label>
            <div class="monto-input-container">
              <span class="currency-symbol">$</span>
              <input type="number" class="form-control monto-input" 
                     [(ngModel)]="montoPago" 
                     step="0.01" min="0"
                     [disabled]="procesandoPago">
            </div>
            <small class="form-text">
              <span *ngIf="tipoPago === 'NORMAL'">Sugerido: {{ formatearMoneda(creditoSeleccionado.pago_semanal) }}</span>
              <span *ngIf="tipoPago === 'COMPLEMENTO'">Sugerido: {{ formatearMoneda(carteraAtrasada) }}</span>
              <span *ngIf="tipoPago === 'ADICIONAL'">Sugerido: {{ formatearMoneda(creditoSeleccionado.pago_semanal) }}</span>
            </small>
          </div>

          <div class="form-group">
            <label class="form-label">MÉTODO DE PAGO *</label>
            <select class="form-control" 
                    [(ngModel)]="metodoPago"
                    [disabled]="procesandoPago">
              <option value="">SELECCIONAR MÉTODO</option>
              <option *ngFor="let metodo of metodosPago" [value]="metodo">
                {{ metodo | titlecase }}
              </option>
            </select>
          </div>

          <!-- Campo para moratorios -->
          <!-- <div class="form-group full-width" *ngIf="tipoPago !== 'ADICIONAL'">
            <label class="form-label">MORA A PAGAR</label>
            <div class="monto-input-container">
              <span class="currency-symbol">$</span>
              <input type="number" class="form-control monto-input" 
                     [(ngModel)]="moratorios" 
                     step="0.01" min="0"
                     [disabled]="procesandoPago">
            </div>
            <small class="form-text">
              Sugerido: {{ formatearMoneda(calcularMoraPendiente(creditoSeleccionado)) }}
            </small>
          </div> -->
        </div>

        <!-- Resumen del pago -->
        <div class="resumen-pago">
          <h5><i class="fas fa-calculator"></i> RESUMEN DEL PAGO</h5>
          <div class="resumen-detalle">
            <div class="resumen-item">
              <span>APLICAR A SEMANA:</span>
              <span class="font-weight-bold">{{ numeroPagoSeleccionado }}/16</span>
            </div>
            <div class="resumen-item">
              <span>PAGO PRINCIPAL:</span>
              <span>{{ formatearMoneda(montoPago || 0) }}</span>
            </div>
            <!-- <div class="resumen-item" *ngIf="moratorios > 0">
              <span>MORA:</span>
              <span class="text-danger">+ {{ formatearMoneda(moratorios) }}</span>
            </div> -->
            <div class="resumen-item total">
              <strong>TOTAL A PAGAR:</strong>
              <strong class="monto-total">{{ formatearMoneda(getTotalPago()) }}</strong>
            </div>
          </div>
        </div>

        <div class="alert alert-info mt-3" *ngIf="tipoPago === 'COMPLEMENTO'">
          <i class="fas fa-info-circle"></i>
          <strong>Nota:</strong> Este pago se aplicará a la semana {{ numeroPagoSeleccionado }} para cubrir atrasos.
        </div>

        <div class="alert alert-success mt-3" *ngIf="tipoPago === 'ADICIONAL'">
          <i class="fas fa-info-circle"></i>
          <strong>Nota:</strong> Este pago adicional se aplicará a la semana {{ numeroPagoSeleccionado }}.
        </div>

        <div class="alert alert-warning mt-3" *ngIf="numeroPagoSeleccionado < calcularProximoNumeroPago(creditoSeleccionado)">
          <i class="fas fa-exclamation-triangle"></i>
          <strong>Atención:</strong> Está aplicando un pago a una semana que ya ha sido pagada (Semana {{ numeroPagoSeleccionado }}). 
          Esto puede ser correcto si está haciendo un ajuste o pago adicional.
        </div>
      </div>
    </div>

    <div class="modal-footer">
      <button class="btn btn-secondary" (click)="cerrarModalPago()" [disabled]="procesandoPago">
        <i class="fas fa-times"></i> CANCELAR
      </button>
      <button class="btn" 
              [ngClass]="{
                'btn-success': tipoPago === 'NORMAL',
                'btn-warning': tipoPago === 'COMPLEMENTO',
                'btn-info': tipoPago === 'ADICIONAL'
              }"
              (click)="registrarPago()" 
              [disabled]="!montoPago || montoPago <= 0 || !metodoPago || !numeroPagoSeleccionado || procesandoPago">
        <i class="fas fa-check" [class.fa-spin]="procesandoPago"></i> 
        {{ procesandoPago ? 'Procesando...' : 'REGISTRAR ' + tipoPago }}
      </button>
    </div>
  </div>
</div>