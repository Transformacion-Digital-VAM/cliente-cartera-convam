<div class="admin-container">
  <!-- Migajas de Pan -->
  <nav class="breadcrumb-nav" aria-label="Migajas de pan">
    <ol class="breadcrumb">
      <li class="breadcrumb-item">
        <a href="/dashboard" class="breadcrumb-link">INICIO</a>
      </li>
      <li class="breadcrumb-item active" aria-current="page">
        GESTIÓN DE PAGOS
      </li>
    </ol>
  </nav>

  <!-- Encabezado -->
  <header class="admin-header">
    <h1 class="reset-title">CARTERA - GESTIÓN DE PAGOS</h1>
  </header>

  <!-- Contenido principal -->
  <div class="admin-content">
    <!-- Barra de búsqueda y filtros -->
    <div class="filtros-section">
      <div class="filtros-card">
        <h3>Filtrar Créditos</h3>
        <div class="filtros-form">
          <div class="form-group">
            <label class="form-label">ALIADOS</label>
            <div class="form-control" style="height: auto; max-height: 150px; overflow-y: auto; padding: 10px;">
              <div *ngFor="let aliado of aliados" style="margin-bottom: 5px;">
                <input type="checkbox" [id]="'aliado-' + aliado.id_aliado"
                  [checked]="esAliadoSeleccionado(aliado.id_aliado)" (change)="onAliadoChange($event, aliado.id_aliado)"
                  style="margin-right: 8px;">
                <label [for]="'aliado-' + aliado.id_aliado" style="cursor: pointer; margin-bottom: 0;">
                  {{ aliado.nom_aliado.trim() }}
                </label>
              </div>
            </div>
          </div>
          <div class="form-group">
            <label class="form-label">ESTADO CRÉDITO</label>
            <select class="form-control" [(ngModel)]="filtroEstado">
              <option value="">TODOS</option>
              <option value="ENTREGADO">ENTREGADO</option>
              <option value="VENCIDO">VENCIDO</option>
            </select>
          </div>
          <div class="form-group">
            <label class="form-label">NOMBRE DEL CLIENTE</label>
            <input type="text" class="form-control" placeholder="Buscar por nombre..." [(ngModel)]="filtroCliente">
          </div>
          <div class="botones-filtros">
            <button class="btn btn-primary" (click)="buscar()">
              <i class="fas fa-search"></i> BUSCAR
            </button>
            <button class="btn btn-outline" (click)="limpiarFiltros()">
              <i class="fas fa-undo"></i> LIMPIAR
            </button>
          </div>
        </div>
      </div>
    </div>

    <div class="pagos-tabla">
      <!-- Tabla de créditos -->
      <section class="tabla-section-vertical">
        <div class="tabla-header">
          <h3>ESTADO DE PAGOS</h3>
          <div class="botones-filtros">
            <button class="btn btn-outline btn-sm" (click)="cargarCreditos()" [disabled]="cargando">
              <i class="fas fa-sync-alt" [class.fa-spin]="cargando"></i>
              {{ cargando ? 'Cargando...' : 'ACTUALIZAR' }}
            </button>
          </div>
        </div>

        <label for="" class="semana-actual">{{ formatearSemanaActual() }}</label>
        <div class="table-container-vertical">
          <table class="table">
            <thead>
              <tr>
                <th></th>
                <th class="text-center">SEMANA</th>
                <th class="text-center">CLIENTE</th>
                <th class="text-center">ID CRÉDITO</th>
                <th class="text-center">ALIADO</th>
                <th class="text-center">DÍA DE PAGO</th>
                <th class="text-center">PAGOS REALIZADOS</th>
                <th class="text-center">PAGO SEMANAL</th>
                <th class="text-center">PRÓXIMA FECHA</th>
                <th class="text-center">TOTAL A PAGAR</th>
                <th class="text-center">TOTAL PAGADO</th>
                <th class="text-center">SALDO PENDIENTE</th>
                <th class="text-center">PRÓXIMO PAGO</th>
                <th class="text-center">DÍAS ATRASO</th>
                <th class="text-center">SEMANAS ATRASO</th>
                <th class="text-center">TOTAL ATRASADO</th>
                <th class="text-center">ACCIONES</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngIf="cargando">
                <td colspan="20" class="text-center">
                  <i class="fas fa-spinner fa-spin"></i> Cargando créditos...
                </td>
              </tr>

              <tr *ngIf="!cargando && !hayCreditos">
                <td colspan="20" class="text-center">
                  No hay créditos entregados
                </td>
              </tr>

              <ng-container *ngFor="let credito of creditosFiltrados">
                <!-- Fila principal con color según estado -->
                <tr class="clickable-row" [ngClass]="credito.viewData?.estadoPago?.filaClase"
                  (click)="toggleFilaDetalle(credito.id_credito)">
                  <td>
                    <i class="fas icon-detalles" [class.fa-chevron-right]="filaExpandida !== credito.id_credito"
                      [class.fa-chevron-down]="filaExpandida === credito.id_credito"></i>
                  </td>
                  <td class="text-center detalles-pago">
                    {{ credito.viewData?.semanaActualCliente }}
                  </td>
                  <td>{{ credito.viewData?.nombreCliente }}</td>
                  <td>{{ getCreditoId(credito) }}</td>
                  <td>{{ credito.viewData?.nombreAliado }}</td>
                  <td class="detalles-pago color:#4a3ef9">{{ credito.viewData?.diaPago }}</td>
                  <td>
                    {{ credito.viewData?.pagosRealizados }}/{{ credito.viewData?.totalSemanas }}
                    <small class="text-muted">({{ credito.viewData?.pagosPendientes }} PENDIENTES)</small>
                  </td>
                  <td class="detalles-pago">{{ formatearMoneda(credito.viewData?.pagoSemanal) }}</td>
                  <td class="col-estado">{{ credito.viewData?.proximaFecha }}</td> <!-- Fecha de pago-->
                  <td class="col-estado">{{ formatearMoneda(credito.total_a_pagar) }}</td> <!-- Total a Pagar-->
                  <td class="col-estado">{{ formatearMoneda(credito.viewData?.totalPagado) }}</td> <!-- Total Pagado-->
                  <td class="col-estado">{{ formatearMoneda(credito.saldo_pendiente) }}</td>
                  <td class="text-center">{{ credito.viewData?.proximoPagoNum }}/{{ credito.viewData?.totalSemanas }}
                  </td>
                  <td class="text-center" [ngClass]="{'text-danger': (credito.viewData?.diasAtraso || 0) > 0}">{{
                    credito.viewData?.diasAtraso }}</td>
                  <td class="text-center" [ngClass]="{'text-danger': (credito.viewData?.semanasAtraso || 0) > 0}">{{
                    credito.viewData?.semanasAtraso }}</td>
                  <td [ngClass]="{'text-danger': (credito.viewData?.totalAtrasado || 0) > 0}">
                    {{ formatearMoneda(credito.viewData?.totalAtrasado || 0) }}
                  </td>
                  <td class="actions-cell">
                    <button class="btn btn-success btn-sm"
                      (click)="abrirModalSeleccion(credito); $event.stopPropagation()">
                      <i class="fas fa-money-bill-wave"></i> PAGO
                    </button>
                  </td>
                </tr>

                <!-- Fila expandible con detalles de pagos -->
                <tr *ngIf="filaExpandida === credito.id_credito" class="detalle-row">
                  <td colspan="20">
                    <div class="detalle-pagos-container">
                      <h5><i class="fas fa-list-alt icon-detalles"></i> DETALLE DE PAGOS</h5>

                      <div class="table-responsive">
                        <table class="table table-sm table-detalle">
                          <thead>
                            <tr>
                              <th>No. PAGO</th>
                              <th class="text-center">TOTAL PAGADO</th>
                              <th class="text-center">FECHA</th>
                              <th class="text-center">CAPITAL</th>
                              <th class="text-center">INTERESES</th>
                              <th class="text-center">MORA</th>
                              <th class="text-center">TIPO</th>
                              <th class="text-center">GARANTÍA ACTUAL</th>
                            </tr>
                          </thead>
                          <tbody>
                            <tr *ngIf="getDetallesPagos(credito.id_credito).length === 0">
                              <td colspan="7" class="text-center text-muted">
                                No hay pagos registrados
                              </td>
                            </tr>
                            <tr *ngFor="let detalle of getDetallesPagos(credito.id_credito)">
                              <td class="font-bold">{{ detalle.numeroPago }}</td>
                              <td class="text-center">{{ formatearMoneda(detalle.montoTotal) }}</td>
                              <td class="text-center">{{ formatearFecha(detalle.fecha) }}</td>
                              <td class="text-center">{{ formatearMoneda(detalle.capital) }}</td>
                              <td class="text-center">{{ formatearMoneda(detalle.intereses) }}</td>
                              <td class="text-center">{{ formatearMoneda(detalle.mora) }}</td>
                              <td class="text-center">
                                <span class="badge" [class.badge-primary]="detalle.tipoPago.includes('PAGO')"
                                  [class.badge-success]="detalle.tipoPago.includes('ADELANTO')">
                                  {{ detalle.tipoPago }}
                                </span>
                              </td>
                              <td class="text-center">
                                <!-- Mostrar el monto total de garantía -->
                                <span class="badge bg-info" *ngIf="credito.total_garantia > 0">
                                  {{ formatearMoneda(credito.total_garantia) }}
                                </span>
                                <span class="badge bg-secondary"
                                  *ngIf="!credito.total_garantia || credito.total_garantia === 0">
                                  Sin garantía
                                </span>
                              </td>
                            </tr>
                          </tbody>
                        </table>
                      </div>
                    </div>
                  </td>
                </tr>
              </ng-container>
            </tbody>
            <tfoot class="table-footer fixed-footer">
              <tr>
                <td colspan="9" class="text-right text-footer ">
                  TOTAL DE CRÉDITOS: {{ creditosFiltrados.length }}
                </td>
                <td class="text-center font-bold text-details">
                  {{ formatearMoneda(calcularTotalAPagarGeneral()) }}
                </td>
                <td class="text-center font-bold text-details">
                  {{ formatearMoneda(calcularTotalPagadoGeneral()) }}
                </td>
                <td class="text-center font-bold text-details bg-light">
                  {{ formatearMoneda(calcularTotalCartera()) }}
                </td>
                <td></td>

                <td colspan="6" class="text-center font-bold text-m text-danger">
                  {{ formatearMoneda(calcularTotalAtrasadoGeneral()) }}
                </td>
              </tr>
            </tfoot>
          </table>
        </div>

        <div *ngIf="!cargando && hayCreditos && creditosFiltrados.length === 0" class="no-data">
          <i class="fas fa-file-invoice-dollar fa-2x"></i>
          <p>No se encontraron créditos con los filtros aplicados</p>
        </div>
      </section>
    </div>

  </div>
</div>

<!-- MODAL DE SELECCIÓN DE TIPO DE PAGO -->
<div class="modal-overlay" *ngIf="modalSeleccionAbierto">
  <div class="modal-content modal-seleccion">
    <div class="modal-header">
      <div class="modal-header-content">
        <div class="modal-icon">
          <i class="fas fa-hand-holding-usd"></i>
        </div>
        <div class="modal-header-text">
          <h3 class="modal-title">SELECCIONAR TIPO DE PAGO</h3>
          <p class="modal-subtitle">{{ getNombreCliente(creditoSeleccionado) }}</p>
        </div>
      </div>
      <button class="modal-close" (click)="cerrarModalSeleccion()">
        <i class="fas fa-times"></i>
      </button>
    </div>

    <div class="modal-body">
      <!-- Información detallada -->
      <div class="info-section">
        <h4><i class="fas fa-exclamation-triangle"></i> SITUACIÓN ACTUAL</h4>
        <div class="info-grid">
          <div class="info-item">
            <strong>Próxima Fecha de Pago:</strong>
            <span [ngClass]="{'text-success': diasAtraso === 0, 'text-danger': diasAtraso > 0}">
              {{ formatearFecha(proximaFechaPago?.toISOString() || '') }}
            </span>
          </div>
          <div class="info-item">
            <strong>Días de Atraso:</strong>
            <span [ngClass]="{'text-success': diasAtraso === 0, 'text-danger': diasAtraso > 0}">
              {{ diasAtraso }} días
            </span>
          </div>
          <div class="info-item">
            <strong>Semanas Atrasadas:</strong>
            <span class="text-danger">{{ semanasAtraso }}</span>
          </div>
          <div class="info-item">
            <strong>Cartera Atrasada:</strong>
            <span>{{ formatearMoneda(carteraAtrasada) }}</span>
          </div>
          <div class="info-item">
            <strong>Mora Pendiente:</strong>
            <span class="text-danger">{{ formatearMoneda(calcularMoraPendiente(creditoSeleccionado)) }}</span>
          </div>
          <div class="info-item">
            <strong>Total Atrasado:</strong>
            <span class="monto-total text-danger">{{ formatearMoneda(totalAtrasado) }}</span>
          </div>
          <div class="info-item">
            <strong>Saldo Pendiente:</strong>
            <span class="monto-total">{{ formatearMoneda(creditoSeleccionado.saldo_pendiente) }}</span>
          </div>
          <div class="info-item">
            <strong>Pago Semanal:</strong>
            <span>{{ formatearMoneda(creditoSeleccionado.pago_semanal) }}</span>
          </div>
          <div class="info-item">
            <strong>Próximo Pago N°:</strong>
            <span>{{ calcularProximoNumeroPago(creditoSeleccionado) }}/{{ obtenerTotalSemanas(creditoSeleccionado)
              }}</span>
          </div>
          <div class="info-item">
            <strong>Pagos Completados:</strong>
            <span>{{ calcularPagosRealizados(creditoSeleccionado) }}</span>
          </div>
          <div class="info-item">
            <strong>Adeudo (Mora):</strong>
            <span class="text-danger">{{ formatearMoneda(calcularMoraPendiente(creditoSeleccionado)) }}</span>
          </div>
          <div class="info-item">
            <strong>Saldo Futuro:</strong>
            <span>{{ formatearMoneda(calcularAdeudoYFuturo(creditoSeleccionado).saldoFuturo) }}</span>
          </div>
        </div>
      </div>

      <!-- Opciones de pago -->
      <div class="opciones-pago">
        <!-- Opción PAGO -->
        <div class="opcion-pago" (click)="abrirModalPago('PAGO')">
          <div class="opcion-icon">
            <i class="fas fa-calendar-week"></i>
          </div>
          <div class="opcion-content">
            <h4>PAGO</h4>
            <p>Pago normal o atrasado</p>
            <div class="opcion-details">
              <span class="monto-sugerido">
                {{ formatearMoneda(creditoSeleccionado.pago_semanal) }}
              </span>
              <span class="text-danger" *ngIf="calcularMoraPendiente(creditoSeleccionado) > 0">
                + {{ formatearMoneda(calcularMoraPendiente(creditoSeleccionado)) }} de mora
              </span>
              <span class="text-danger" *ngIf="semanasAtraso > 0">
                {{ semanasAtraso }} semana(s) atrasada(s)
              </span>
            </div>
          </div>
          <div class="opcion-arrow">
            <i class="fas fa-chevron-right"></i>
          </div>
        </div>

        <!-- Opción ADELANTO -->
        <div class="opcion-pago"
          (click)="calcularMoraPendiente(creditoSeleccionado) === 0 ? abrirModalPago('ADELANTO') : null"
          [ngClass]="{'disabled': calcularMoraPendiente(creditoSeleccionado) > 0}"
          [title]="calcularMoraPendiente(creditoSeleccionado) > 0 ? 'No disponible con mora pendiente' : ''">
          <div class="opcion-icon">
            <i class="fas fa-forward"></i>
          </div>
          <div class="opcion-content">
            <h4>ADELANTO</h4>
            <p>Pago de semana futura</p>
            <div class="opcion-details">
              <span class="text-success" *ngIf="calcularMoraPendiente(creditoSeleccionado) === 0">
                Aplica automáticamente a próxima semana
              </span>
              <span class="text-danger" *ngIf="calcularMoraPendiente(creditoSeleccionado) > 0">
                No disponible (mora pendiente)
              </span>
            </div>
          </div>
          <div class="opcion-arrow">
            <i class="fas fa-chevron-right"></i>
          </div>
        </div>
      </div>
    </div>

    <div class="modal-footer">
      <button class="btn btn-secondary" (click)="cerrarModalSeleccion()">
        <i class="fas fa-times"></i> CANCELAR
      </button>
    </div>
  </div>
</div>

<!-- MODAL DE PAGO -->
<div class="modal-overlay" *ngIf="modalPagoAbierto && tipoPago === 'PAGO'">
  <div class="modal-content">
    <div class="modal-header">
      <div class="modal-header-content">
        <div class="modal-icon bg-primary">
          <i class="fas fa-calendar-week"></i>
        </div>
        <div class="modal-header-text">
          <h3 class="modal-title">PAGO</h3>
          <p class="modal-subtitle">{{ getNombreCliente(creditoSeleccionado) }}</p>
        </div>
      </div>
      <button class="modal-close" (click)="cerrarModalPago()" [disabled]="procesandoPago">
        <i class="fas fa-times"></i>
      </button>
    </div>

    <div class="modal-body">
      <!-- Información de situación actual -->
      <div class="info-section">
        <h4><i class="fas fa-exclamation-triangle"></i> SITUACIÓN ACTUAL</h4>
        <div class="info-grid">
          <div class="info-item">
            <strong>Próxima Fecha:</strong>
            <span>{{ formatearFecha(proximaFechaPago?.toISOString() || '') }}</span>
          </div>
          <div class="info-item">
            <strong>Días de Atraso:</strong>
            <span [ngClass]="{'text-success': diasAtraso === 0, 'text-danger': diasAtraso > 0}">
              {{ diasAtraso }} días
            </span>
          </div>
          <div class="info-item">
            <strong>Semanas Atrasadas:</strong>
            <span class="text-danger">{{ semanasAtraso }}</span>
          </div>
          <div class="info-item">
            <strong>Mora Pendiente:</strong>
            <span class="text-danger">{{ formatearMoneda(calcularMoraPendiente(creditoSeleccionado)) }}</span>
          </div>
          <div class="info-item">
            <strong>Saldo Pendiente:</strong>
            <span class="monto-total">{{ formatearMoneda(creditoSeleccionado.saldo_pendiente) }}</span>
          </div>
          <div class="info-item">
            <strong>Próximo Pago N°:</strong>
            <span>{{ calcularProximoNumeroPago(creditoSeleccionado) }}/{{ obtenerTotalSemanas(creditoSeleccionado)
              }}</span>
          </div>
        </div>
      </div>

      <!-- Formulario de pago -->
      <div class="form-section">
        <div class="form-grid">
          <!-- Selector de número de semana/pago SOLO PARA PAGO -->
          <div class="form-group full-width">
            <label class="form-label">
              <i class="fas fa-calendar-alt"></i> SELECCIONE LA SEMANA *
            </label>
            <select class="form-control" [(ngModel)]="numeroPagoSeleccionado" [disabled]="procesandoPago">
              <option *ngFor="let semana of obtenerSemanasDisponibles()" [value]="semana.numero"
                [disabled]="semana.disabled">
                Sem {{ semana.numero }}/{{ obtenerTotalSemanas(creditoSeleccionado) }} - {{
                getEstadoSemana(semana.numero).texto }} ({{
                formatearFecha(calcularFechaSemana(creditoSeleccionado, semana.numero).toISOString()) }})
              </option>
            </select>
            <small class="form-text text-info">
              <i class="fas fa-info-circle"></i>
              <span *ngIf="numeroPagoSeleccionado === calcularProximoNumeroPago(creditoSeleccionado)">
                Esta es la próxima semana que debe pagarse
              </span>
              <span *ngIf="numeroPagoSeleccionado < calcularProximoNumeroPago(creditoSeleccionado)">
                Esta semana está atrasada
              </span>
              <span *ngIf="numeroPagoSeleccionado > calcularProximoNumeroPago(creditoSeleccionado)">
                Esta es una semana futura
              </span>
            </small>
          </div>

          <div class="form-group">
            <label class="form-label">MONTO DEL PAGO *</label>
            <div class="monto-input-container">
              <span class="currency-symbol">$</span>
              <input type="number" class="form-control monto-input" [(ngModel)]="montoPago" step="0.01" min="0"
                [disabled]="procesandoPago">
            </div>
            <small class="form-text">
              Sugerido: {{ formatearMoneda(creditoSeleccionado.pago_semanal) }}
            </small>
          </div>

          <div class="form-group">
            <label class="form-label">MÉTODO DE PAGO *</label>
            <select class="form-control" [(ngModel)]="metodoPago" [disabled]="procesandoPago" required>
              <option *ngIf="!metodoPago" value="" disabled selected>
                Seleccione un método de pago
              </option>
              <option *ngFor="let metodo of metodosPago" [value]="metodo">
                {{ metodo | titlecase }}
              </option>
            </select>

            <!-- Mensaje de validación -->
            <div *ngIf="!metodoPago && procesandoPago" class="text-danger small">
              Por favor seleccione un método de pago
            </div>
          </div>

          <!-- Campo para moratorios solo si hay mora pendiente -->
          <div class="form-group full-width" *ngIf="calcularMoraPendiente(creditoSeleccionado) > 0">
            <label class="form-label">MORA A PAGAR</label>
            <div class="monto-input-container">
              <span class="currency-symbol">$</span>
              <input type="number" class="form-control monto-input" [(ngModel)]="moratorios" step="0.01" min="0"
                [disabled]="procesandoPago">
            </div>
            <small class="form-text">
              Moratoria pendiente: {{ formatearMoneda(calcularMoraPendiente(creditoSeleccionado)) }}
            </small>
          </div>
        </div>

        <!-- Resumen del pago -->
        <div class="resumen-pago">
          <h5><i class="fas fa-calculator"></i> RESUMEN DEL PAGO</h5>
          <div class="resumen-detalle">
            <div class="resumen-item">
              <span>APLICAR A SEMANA:</span>
              <span class="font-weight-bold">{{ numeroPagoSeleccionado }}/{{ obtenerTotalSemanas(creditoSeleccionado)
                }}</span>
            </div>
            <div class="resumen-item">
              <span>PAGO PRINCIPAL:</span>
              <span>{{ formatearMoneda(montoPago || 0) }}</span>
            </div>
            <div class="resumen-item" *ngIf="moratorios > 0">
              <span>MORA:</span>
              <span class="text-danger">+ {{ formatearMoneda(moratorios) }}</span>
            </div>
            <div class="resumen-item total">
              <strong>TOTAL A PAGAR:</strong>
              <strong class="monto-total">{{ formatearMoneda(getTotalPago()) }}</strong>
            </div>
          </div>
        </div>

        <div class="alert alert-info mt-3"
          *ngIf="numeroPagoSeleccionado > calcularProximoNumeroPago(creditoSeleccionado)">
          <i class="fas fa-info-circle"></i>
          <strong>Nota:</strong> Este pago se aplicará a la semana {{ numeroPagoSeleccionado }}.
          Si hay semanas atrasadas, primero se cubrirán las semanas en mora.
        </div>
      </div>
    </div>

    <div class="modal-footer">
      <button class="btn btn-secondary" (click)="cerrarModalPago()" [disabled]="procesandoPago">
        <i class="fas fa-times"></i> CANCELAR
      </button>
      <button class="btn btn-primary" (click)="registrarPago()"
        [disabled]="!montoPago || montoPago <= 0 || !metodoPago || !numeroPagoSeleccionado || procesandoPago">
        <i class="fas fa-check" [class.fa-spin]="procesandoPago"></i>
        {{ procesandoPago ? 'Procesando...' : 'REGISTRAR PAGO' }}
      </button>
    </div>
  </div>
</div>

<!-- MODAL DE ADELANTO-->
<div class="modal-overlay" *ngIf="modalPagoAbierto && tipoPago === 'ADELANTO'">
  <div class="modal-content">
    <div class="modal-header">
      <div class="modal-header-content">
        <div class="modal-icon bg-success">
          <i class="fas fa-forward"></i>
        </div>
        <div class="modal-header-text">
          <h3 class="modal-title">ADELANTO</h3>
          <p class="modal-subtitle">{{ getNombreCliente(creditoSeleccionado) }}</p>
        </div>
      </div>
      <button class="modal-close" (click)="cerrarModalPago()" [disabled]="procesandoPago">
        <i class="fas fa-times"></i>
      </button>
    </div>

    <div class="modal-body">
      <!-- Información de situación actual -->
      <div class="info-section">
        <h4><i class="fas fa-exclamation-triangle"></i> SITUACIÓN ACTUAL</h4>
        <div class="info-grid">
          <div class="info-item">
            <strong>Próxima Fecha:</strong>
            <span>{{ formatearFecha(proximaFechaPago?.toISOString() || '') }}</span>
          </div>
          <div class="info-item">
            <strong>Días de Atraso:</strong>
            <span [ngClass]="{'text-success': diasAtraso === 0, 'text-danger': diasAtraso > 0}">
              {{ diasAtraso }} días
            </span>
          </div>
          <div class="info-item">
            <strong>Mora Pendiente:</strong>
            <span class="text-danger">{{ formatearMoneda(calcularMoraPendiente(creditoSeleccionado)) }}</span>
          </div>
          <div class="info-item">
            <strong>Saldo Pendiente:</strong>
            <span class="monto-total">{{ formatearMoneda(creditoSeleccionado.saldo_pendiente) }}</span>
          </div>
          <div class="info-item">
            <strong>Próximo Pago N°:</strong>
            <span>{{ calcularProximoNumeroPago(creditoSeleccionado) }}/{{ obtenerTotalSemanas(creditoSeleccionado)
              }}</span>
          </div>
        </div>
      </div>

      <!-- Formulario de adelanto -->
      <div class="form-section">
        <div class="alert alert-info">
          <i class="fas fa-info-circle"></i>
          <h5>Adelanto a semana futura</h5>
        </div>

        <div class="form-grid">
          <div class="form-group">
            <label class="form-label">MONTO DEL ADELANTO *</label>
            <div class="monto-input-container">
              <span class="currency-symbol">$</span>
              <input type="number" class="form-control monto-input" [(ngModel)]="montoPago" step="0.01" min="0"
                placeholder="Ej: {{ creditoSeleccionado.pago_semanal }}" [disabled]="procesandoPago">
            </div>
            <small class="form-text">
              Monto sugerido: {{ formatearMoneda(creditoSeleccionado.pago_semanal) }}
            </small>
          </div>

          <div class="form-group">
            <label class="form-label">MÉTODO DE PAGO *</label>
            <select class="form-control" [(ngModel)]="metodoPago" [disabled]="procesandoPago">
              <option value="">Seleccionar método</option>
              <option *ngFor="let metodo of metodosPago" [value]="metodo">
                {{ metodo | titlecase }}
              </option>
            </select>
          </div>
        </div>

        <!-- Resumen del adelanto -->
        <div class="resumen-pago">
          <h5><i class="fas fa-calculator"></i> RESUMEN DEL ADELANTO</h5>
          <div class="resumen-detalle">
            <div class="resumen-item">
              <span>TIPO:</span>
              <span class="font-weight-bold">ADELANTO A SEMANA FUTURA</span>
            </div>
            <div class="resumen-item">
              <span>MONTO:</span>
              <span>{{ formatearMoneda(montoPago || 0) }}</span>
            </div>
            <div class="resumen-item total">
              <strong>TOTAL A PAGAR:</strong>
              <strong class="monto-total">{{ formatearMoneda(getTotalPago()) }}</strong>
            </div>
          </div>
        </div>

        <div class="alert alert-success mt-3">
          <i class="fas fa-info-circle"></i>
          <strong>Nota:</strong> El sistema asignará automáticamente este adelanto a la próxima semana pendiente en el
          calendario.
        </div>
      </div>
    </div>

    <div class="modal-footer">
      <button class="btn btn-secondary" (click)="cerrarModalPago()" [disabled]="procesandoPago">
        <i class="fas fa-times"></i> CANCELAR
      </button>
      <button class="btn btn-success" (click)="registrarPago()"
        [disabled]="!montoPago || montoPago <= 0 || !metodoPago || procesandoPago">
        <i class="fas fa-check" [class.fa-spin]="procesandoPago"></i>
        {{ procesandoPago ? 'Procesando...' : 'REGISTRAR ADELANTO' }}
      </button>
    </div>
  </div>
</div>